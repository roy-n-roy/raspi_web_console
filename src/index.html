<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>RasPi Remote Console</title>
	<style type="text/css">
		body {
			margin: 2px;
			padding: 0px;
		}
		video {
			width: 100%;
			object-fit: scale-down;
		}
	</style>
</head>
<body>
	<video id="remote_video" autoplay mutedv style="border: 1px solid gray;"></video>
	<script src="/js/socket.io.slim.js"></script>
	<script src="/webrtc.js"></script>
	<script>
		var lastX = 0, lastY = 0;
		// イベントとコールバックの定義
		var socket = io.connect("/");
		
		// ソケット切断時
		socket.on("disconnect", () => {
			window.webrtc.disconnect();
			if (window.confirm("切断されました。再接続しますか?")){
				socket = socket.connect();
				window.webrtc.connect();
			};
		});

		window.onload = () => {
			// マウス・キーボード入力時
			// キーボード: keydown
			window.addEventListener('keydown', (event) => {
				socket.emit('keydown', event.type, event.code);
				// デフォルトイベントをキャンセル
				event.preventDefault();
			}, false);
			// キーボード: keyup
			window.addEventListener('keyup', (event) => {
				socket.emit('keyup', event.type, event.code);
				// デフォルトイベントをキャンセル
				event.preventDefault();
			}, false);
			// マウス: mousemove
			window.addEventListener('mousemove', (event) => {
				socket.emit('mousemove', event.movementX, event.movementY);
			});
			// マウス: mousedown
			window.addEventListener('mousedown', (event) => {
				socket.emit('mousedown', event.type, event.button);
				// デフォルトイベントをキャンセル
				event.preventDefault();
			}, false);
			// マウス: mouseup
			window.addEventListener('mouseup', (event) => {
				socket.emit('mouseup', event.type, event.button);
				// デフォルトイベントをキャンセル
				event.preventDefault();
			}, false);
			// マウス: contextmenu
			window.addEventListener("contextmenu", (event) => {
				// デフォルトイベントをキャンセル
				event.preventDefault();
			}, false);
			history.pushState(null, null, null);
			// マウス: browserback
			window.addEventListener("popstate", (event) =>{
				// デフォルトイベントをキャンセル
				history.pushState(null, null, null);
				event.preventDefault();
			}, false);
			// ホイール: wheel
			window.addEventListener('wheel', (event) => {
				socket.emit('wheel', event.deltaX, event.deltaY);
				// デフォルトイベントをキャンセル
				event.preventDefault();
			}, false);
			// タッチ: touchstart
			window.addEventListener("touchstart", (event) => {
				lastX = event.changedTouches[0].clientX,
				lastY = event.changedTouches[0].clientY;
				// デフォルトイベントをキャンセル
				event.preventDefault();
			}, false);
			// タッチ: touchend
			window.addEventListener("touchend", (event) => {
				// デフォルトイベントをキャンセル
				event.preventDefault();
			}, false);
			// タッチ: touchmove
			window.addEventListener("touchmove", (event) => {
				const X = event.changedTouches[0].clientX,
					  Y = event.changedTouches[0].clientY;
				if (event.touches.length == 1){
					socket.emit('touchmove', X - lastX, Y - lastY);
				}else{
					socket.emit('wheel', Math.sign(X - lastX), Math.sign(Y - lastY));
				}
				lastX = X, lastY = Y;
				// デフォルトイベントをキャンセル
				event.preventDefault();
			}, false);

			// WebRTC接続
			window.webrtc.connect();
		};

		window.onclose = () => {
			window.webrtc.disconnect();
		};
	</script>
</body>
</html>